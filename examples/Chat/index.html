<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Microger Chat</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="https://netpie.io/microgear.js"></script>
	  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

	  <script>
      var member = [];
      var autoscroll = true;
      var token_online = [];
      var token_offline = [];
      var name = "";
      var microgear ;
      function setInformation(){
        before_connect();

        const APPKEY = <APPKEY>;
        const APPSECRET = <APPSECRET>;
        const APPID = <APPID>;

        name = document.getElementById('name').value;
        microgear = Microgear.create({
          gearkey: APPKEY,
          gearsecret: APPSECRET
        });
        microgear.on('message',function(topic,msg) {
          console.log(msg);
          var msgi = msg.split("#");
          if(msgi[0]=="I'm new" && msgi[1]!=name){
            if(member.indexOf(msgi[1])<0){
              member.push(msgi[1]);
            document.getElementById("member_table").innerHTML += '<tr><td class="info" id="'+msgi[1]+'">'+msgi[1]+'<span class="glyphicon glyphicon glyphicon-heart pull-right online" aria-hidden="true" id="color'+msgi[1]+'"></span></td></tr>'
            }
            else{
              var id = "#color"+msgi[1];
              $(id).removeClass('offline');
              $(id).addClass('online');
            }
          }
          if(msgi[0]=="Hi" && msgi[1]!=name){
            microgear.publish("/chat","Hey#"+name);
          }
          if(msgi[0]=="Hey" && msgi[1]!=name){
            if(member.indexOf(msgi[1])<0){
              member.push(msgi[1]);
              document.getElementById("member_table").innerHTML += '<tr><td class="info" id="'+msgi[1]+'">'+msgi[1]+'<span class="glyphicon glyphicon glyphicon-heart pull-right online" aria-hidden="true" id="color'+msgi[1]+'"></span></td></tr>'
            }
          }
          if(msgi[0]=="msg" && msgi[1]!=name){
            document.getElementById("data").innerHTML += "<div class="+'"floating-left-box topic"'+"><strong>"+msgi[1]+"</strong></div>"+"<div class="+'"floating-left-box msg"'+">"+msgi[2]+"</div>"+"</div>"+"<div class="+'"clear-box"'+">"+"</div><br>";
            auto_scroll();
          }
          if(msgi[0]=="bye" && msgi[1]!=name){
            if(member.indexOf(msgi[1])>=0){
              var id = "#color"+msgi[1];
              $(id).removeClass('online');
              $(id).addClass('offline');
            }
          }
        });

        microgear.on('connected', function() {
          microgear.subscribe("/chat");
          microgear.setname(name);
          microgear.publish("/chat","I'm new#"+name);
          microgear.publish("/chat","Hi#"+name);
          after_connect();
        });
        microgear.on('present', function(event) {
          console.log(event);
        });
        microgear.on('absent', function(event) {
          console.log(event);
        });
        microgear.resettoken();
        microgear.connect(APPID);
      }
  	</script>
  </head>
  <body onunload="disconnect()">
    <div class="container-fluid" id="container_flow">
      <nav class="navbar navbar-default navbar-fixed-top bar_form">
        <div class="container">
          <div class="navbar-header">
            <button id="aria_expanded" type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar" aria-expanded="true" aria-controls="navbar">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#"><img src="img/netpie_logo.png" class="logo_bar"></a>
          </div>
          <div id="navbar" class="navbar-collapse collapse in" aria-expanded="true">
            <form action="javascript:setInformation()" id="action_form">
              <ul class="nav navbar-nav">
                <br>
                <li class="padding_input"><input type="text" class="form-control padding_input delete_border_radius" placeholder="Name" aria-describedby="name" required id="name"></li>
              </ul>
              <div id="button_control" class="row center_">
                <button type="submit" class="btn btn-primary navbar-btn center_c btn" id="buttoncontrol">CONNECT</button>
              </div>
            </form>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    	<div class="row">
    		<div class="col-sm-3 col_control" id="col_control">
          <br>
    			<div id="logo" class="row">
    				<div class="center_"><img src="img/netpie_logo.png" class="logo"></div>
    			</div>
    			<hr>
          <br>
          <form action="javascript:setInformation()" id="action_form1">
            <div id="information" class="row center_">
                <br>
                <input type="text" class="form-control delete_border_radius" placeholder="Name" aria-describedby="name" required id="name1">
            </div>
            <br>
            <div id="button_control" class="row center_">
              <button type="submit" class="btn btn-primary navbar-btn center_c btn" id="buttoncontrol1">CONNECT</button>
            </div>
          </form>
          <br>
    			<div id="status" class="row center-block">
            <div class="panel panel-primary">
              <div class="panel-heading">
                <h3 class="panel-title">Who's Online!</h3>
              </div>
              <div class="panel-body status_body">
                <table class="table table-hover" id="member_table">
                </table>
              </div>
            </div>
    			</div>
    			<br>
    		</div>
    		<div class="col-sm-9 col-sm-offset-3 col-xs-12  col_console">
          <div class="box_console" id="box_console">
            <span id="console_connect"><h1>Microgear Chat</h1></span>
          </div>
          <div id="msgbar" class="row">
			      <div id="data"></div>
            <div id="bottom" class="buttom"><a href="bottom"></a></div>
          </div>
          <div class="row chat_tool" id="chat">
            <div class="input-group">
              <input class="form-control chat_box col-" rows="1" id="msg" onkeypress="chat()"></input>
              <span class="input-group-btn">
                <button class="btn btn-default btn-lg chat_button" type="button" onClick="chat1()">SEND</button>
              </span>
            </div>
          </div>
    		</div>
    	</div>
    </div>
  </body>
  <script type="text/javascript">
    function disconnect(){
      microgear.publish("/chat","bye#"+name);
    }
    function chat(){
      if (event.keyCode == 13) {
        var msg = document.getElementById('msg').value;
        if(msg!=""){
          document.getElementById("data").innerHTML += "<div class="+'"floating-right-box msg"'+">"+msg+"</div>"+"</div>"+"<div class="+'"clear-box"'+">"+"</div><br>";
          document.getElementById('msg').value = "";
          microgear.publish("/chat","msg#"+name+"#"+msg);
        }
      }
    }
    function chat1(){
      var msg = document.getElementById('msg').value;
      if(msg!=""){
        document.getElementById("data").innerHTML += "<div class="+'"floating-right-box msg"'+">"+msg+"</div>"+"</div>"+"<div class="+'"clear-box"'+">"+"</div><br>";
        document.getElementById('msg').value = "";
        microgear.publish("/chat","msg#"+name+"#"+msg);
      }
    }
    $(function () {
      var $win = $(window);
      $win.scroll(function () {
        if ($win.height() + $win.scrollTop()< $(document).height())
          autoscroll = false;
        else if ($win.height() + $win.scrollTop()== $(document).height()) {
          autoscroll = true;
        }
      });
    });
    $('#name').keyup(function() {
      document.getElementById('name1').value = $(this).val();
    });
    $('#name1').keyup(function() {
      document.getElementById('name').value = $(this).val();
    });
    
    function after_connect(){
      $("#box_console").hide();
      $("#buttoncontrol").removeClass('btn-primary');
      $("#buttoncontrol").addClass('btn-danger');
      document.getElementById('buttoncontrol').innerHTML = "DISCONNECT";
      $('#action_form').attr('action', 'javascript:reset()');
      $("#buttoncontrol1").removeClass('btn-primary');
      $("#buttoncontrol1").addClass('btn-danger');
      document.getElementById('buttoncontrol1').innerHTML = "DISCONNECT";
      $('#action_form1').attr('action', 'javascript:reset()');
      $("#name").prop('disabled', true);
      $("#name1").prop('disabled', true);
      $("#navbar").prop('aria-expanded', false);
      $("#navbar").removeClass('in');
    }
    function before_connect(){
      document.getElementById('console_connect').innerHTML = '<img src="img/load.gif" class="img_load">';
    }
    function reset(){
      window.location.reload();
    }
    function auto_scroll(){
      if(autoscroll){
        document.getElementById('bottom').scrollIntoView();
      }
    }
  </script>
</html>
